workspace:
  base: /go
  path: src/github.com/myth/ulv-auth

pipeline:
  test:
    image: lushdigital/docker-golang-dep
    commands:
      - cd /go/src/github.com/myth/ulv-auth
      - go get -u github.com/golang/dep/cmd/dep
      - find / -name 'dep'
      - /go/bin/dep ensure
      - go get -u golang.org/x/tools/cmd/cover
      - go test -cover $(go list ./... | grep -v /vendor/)

  build:
    image: golang:1.8
    commands:
      - go build
    when:
      event: [ push, tag ]

  deploy:
    image: plugins/ssh
    when:
      branch: master
      event: push
    host: ace.ulv.io
    port: 22
    username: root
    secrets: [ ssh_key ]
    script:
      - systemctl status ulv-auth
      - echo Change this to restart later

